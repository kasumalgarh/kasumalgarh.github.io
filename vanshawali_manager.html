<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8">
    <title>Vanshawali Manager - KASUMALGARH</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Playfair+Display:ital,wght@0,400;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        /* ----------------------------- */
        /* ‚ú® ROYAL DARK THEME (SAME AS DASHBOARD) */
        /* ----------------------------- */
        :root {
            --bg-dark: #050510;
            --glass-bg: rgba(20, 20, 35, 0.7);
            --gold-primary: #d4af37;
            --gold-gradient: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7);
            --text-light: #e0e0e0;
            --danger-red: #ff4444;
            --success-green: #4caf50;
            --edit-yellow: #ffeb3b;
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #1a0b0b 0%, #000000 100%);
            color: var(--text-light);
            font-family: 'Lato', sans-serif;
            text-align: center;
        }

        /* TEXTURE OVERLAY */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/black-scales.png');
            opacity: 0.3; pointer-events: none; z-index: -1;
        }

        /* NAVBAR */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px;
            background: rgba(10, 10, 20, 0.9);
            border-bottom: 2px solid var(--gold-primary);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }

        .brand-title {
            font-family: 'Cinzel', serif; font-size: 1.2em; font-weight: 700;
            background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--gold-primary);
            color: var(--gold-primary);
            padding: 8px 20px;
            border-radius: 20px;
            text-decoration: none;
            transition: 0.3s;
        }
        .back-btn:hover { background: var(--gold-primary); color: #000; }

        /* PASSWORD OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .login-box {
            background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 15px;
            border: 1px solid var(--gold-primary); text-align: center;
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.2); max-width: 400px; width: 90%;
        }

        /* CONTAINER */
        .container { max-width: 1400px; margin: 30px auto; padding: 20px; display: flex; gap: 20px; flex-wrap: wrap; }

        /* PANELS */
        .panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .editor-panel { flex: 1; min-width: 400px; text-align: left; }
        .preview-panel { flex: 1; min-width: 400px; border: 2px solid var(--gold-primary); background: #fffbf0; color: #333; max-height: 85vh; overflow-y: auto; }

        /* HEADINGS */
        h2, h3 { font-family: 'Cinzel', serif; color: var(--gold-primary); border-bottom: 1px solid rgba(212, 175, 55, 0.3); padding-bottom: 10px; margin-top: 0; }
        
        /* SECTIONS */
        .tool-section { margin-bottom: 25px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border-left: 3px solid #555; }
        .tool-section.add { border-color: var(--success-green); }
        .tool-section.edit { border-color: var(--edit-yellow); }
        .tool-section.delete { border-color: var(--danger-red); }

        .section-title { font-weight: bold; font-size: 1.1em; margin-bottom: 10px; display: block; color: #fff; }
        .note { font-size: 0.8em; color: #aaa; margin-bottom: 10px; display: block; }

        /* INPUTS */
        input[type="text"], input[type="password"], textarea {
            width: 100%; padding: 10px; margin-bottom: 10px;
            background: rgba(0,0,0,0.5); border: 1px solid #555;
            color: #fff; border-radius: 5px; box-sizing: border-box;
            font-family: 'Lato', sans-serif;
        }
        input:focus { border-color: var(--gold-primary); outline: none; }

        /* BUTTONS */
        .btn {
            width: 100%; padding: 10px; border: none; border-radius: 5px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
            font-family: 'Cinzel', serif; letter-spacing: 1px;
        }
        .btn-load { background: #008080; color: white; margin-bottom: 15px; }
        .btn-add { background: var(--success-green); color: white; }
        .btn-edit { background: var(--edit-yellow); color: black; }
        .btn-delete { background: var(--danger-red); color: white; }
        .btn-save { 
            background: var(--gold-gradient); color: #2c0e0e; 
            font-size: 1.2em; margin-top: 20px; border: 2px solid #fff; 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }

        /* PREVIEW TREE STYLE */
        .tree ul { list-style: none; padding-left: 20px; margin: 0; border-left: 2px solid #800000; }
        .tree li { padding: 5px 0; position: relative; }
        .member-card { border: 1px solid #b38728; padding: 2px 8px; background: #fff; color: #800000; font-weight: bold; display: inline-block; border-radius: 3px; font-size: 0.9em; }

        /* LOADING OVERLAY */
        #loadingOverlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; color: white; flex-direction: column;
        }

        /* MOBILE FIX */
        @media (max-width: 800px) {
            .container { flex-direction: column; }
            .preview-panel { max-height: 400px; }
        }
    </style>
</head>

<body>

    <div id="loadingOverlay">
        <i class="fas fa-spinner fa-spin" style="font-size: 50px; color: var(--gold-primary);"></i>
        <p style="margin-top: 20px;">Processing Request...</p>
    </div>

    <div id="login-overlay">
        <div class="login-box animate__animated animate__zoomIn">
            <i class="fas fa-user-shield" style="font-size: 50px; color: #d4af37; margin-bottom: 15px;"></i>
            <h2 style="margin: 0; color: #d4af37; font-size: 1.5em;">SECURITY CHECK</h2>
            <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">Enter Password to Manage Tree</p>
            
            <input type="password" id="passInput" placeholder="Password" style="text-align:center;">
            <button onclick="checkPass()" class="btn btn-save">UNLOCK</button>
            <p id="errorMsg" style="color:#ff4444; font-size:0.8em; margin-top:10px; display:none;">Incorrect Password</p>
        </div>
    </div>

    <div id="main-interface" style="display:none;">
        
        <nav class="navbar">
            <div class="brand-title"><i class="fas fa-sitemap"></i> VANSHAWALI MANAGER</div>
            <a href="admin_dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
        </nav>

        <div class="container">
            
            <div class="panel editor-panel">
                <h2>üõ†Ô∏è Control Panel</h2>

                <button onclick="fetchLiveCode()" class="btn btn-load"><i class="fas fa-sync"></i> REFRESH / LOAD CODE</button>
                <textarea id="inputHtml" style="display:none;"></textarea>
                
                <div class="tool-section add">
                    <span class="section-title" style="color:var(--success-green);"><i class="fas fa-plus-circle"></i> ‡§®‡§æ‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (Add Member)</span>
                    <span class="note">‡§¶‡§æ‡§¶‡§æ ‡§î‡§∞ ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Æ‡•à‡§ö ‡§π‡•ã‡§®‡§æ ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§</span>
                    <input type="text" id="add_grand" placeholder="‡§¶‡§æ‡§¶‡§æ ‡§ú‡•Ä (Grandfather's Name)">
                    <input type="text" id="add_father" placeholder="‡§™‡§ø‡§§‡§æ ‡§ú‡•Ä (Father's Name)">
                    <input type="text" id="add_child" placeholder="‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ (New Member Name)">
                    <button onclick="addName()" class="btn btn-add">ADD NAME</button>
                </div>

                <div class="tool-section edit">
                    <span class="section-title" style="color:var(--edit-yellow);"><i class="fas fa-pen"></i> ‡§®‡§æ‡§Æ ‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç (Correction)</span>
                    <span class="note">‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è 3 ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç (Old Info + New Name)‡•§</span>
                    <input type="text" id="edit_grand" placeholder="‡§¶‡§æ‡§¶‡§æ ‡§ú‡•Ä (Grandfather - Verify)">
                    <input type="text" id="edit_father" placeholder="‡§™‡§ø‡§§‡§æ ‡§ú‡•Ä (Father - Verify)">
                    <input type="text" id="edit_old" placeholder="‡§ó‡§≤‡§§ ‡§®‡§æ‡§Æ (Wrong Name)">
                    <input type="text" id="edit_new" placeholder="‡§∏‡§π‡•Ä ‡§®‡§æ‡§Æ (Correct Name)">
                    <button onclick="editName()" class="btn btn-edit">CORRECT NAME</button>
                </div>

                <div class="tool-section delete">
                    <span class="section-title" style="color:var(--danger-red);"><i class="fas fa-trash"></i> ‡§®‡§æ‡§Æ ‡§π‡§ü‡§æ‡§è‡§Ç (Delete)</span>
                    <span class="note">‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§®‡§æ‡§Æ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ‡•§</span>
                    <input type="text" id="del_grand" placeholder="‡§¶‡§æ‡§¶‡§æ ‡§ú‡•Ä (Grandfather - Verify)">
                    <input type="text" id="del_father" placeholder="‡§™‡§ø‡§§‡§æ ‡§ú‡•Ä (Father - Verify)">
                    <input type="text" id="del_name" placeholder="‡§π‡§ü‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§®‡§æ‡§Æ (Name to Delete)">
                    <button onclick="deleteName()" class="btn btn-delete">DELETE NAME</button>
                </div>

                <div style="border-top: 1px solid #555; padding-top: 15px;">
                    <textarea id="outputHtml" readonly style="display:none;"></textarea>
                    <button onclick="saveToGitHub()" class="btn btn-save"><i class="fas fa-cloud-upload-alt"></i> PUBLISH TO WEBSITE</button>
                </div>
            </div>

            <div class="panel preview-panel">
                <h3 style="text-align:center; color:#800000; position:sticky; top:0; background:#fffbf0; padding:10px; z-index:10; border-bottom:2px solid #800000;">
                    <i class="fas fa-eye"></i> Live Tree Preview
                </h3>
                <div id="livePreview" class="tree">
                    <p style="text-align:center; padding:20px; color:#666;">Load Code to see the Tree...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // CONFIGURATION
        const GITHUB_USERNAME = "kasumalgarh";       
        const REPO_NAME = "kasumalgarh.github.io";   
        const FILE_PATH = "vanshawali.html";         
        const BRANCH = "main";                       
        const ADMIN_PASSWORD = "kasumalgarh2025";    // Default Password

        // 1. PASSWORD CHECK
        function checkPass() {
            const input = document.getElementById('passInput').value;
            if(input === ADMIN_PASSWORD) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('main-interface').style.display = 'block';
                fetchLiveCode(); // Auto load code
            } else { 
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // LOADING SPINNER
        function loading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        // 2. FETCH LIVE CODE
        async function fetchLiveCode() {
            loading(true);
            try {
                const response = await fetch(FILE_PATH + '?v=' + new Date().getTime());
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                document.getElementById('inputHtml').value = text;
                document.getElementById('outputHtml').value = text;
                loadPreview();
            } catch (err) { alert("Error: " + err.message); } 
            finally { loading(false); }
        }

        function loadPreview() {
            const code = document.getElementById('inputHtml').value;
            if(code) document.getElementById('livePreview').innerHTML = code;
        }

        // HELPER: FIND NODE BASED ON 3 LEVELS (Grand -> Father -> Child)
        function findNode(doc, grandName, fatherName, childName) {
            const allSpans = doc.querySelectorAll('.member-name');
            for (let span of allSpans) {
                if (span.textContent.trim() === childName) {
                    const childLi = span.closest('li');
                    const parentUl = childLi.parentElement;
                    const fatherLi = parentUl.closest('li'); // Father Node
                    
                    if (fatherLi) {
                        const fatherSpan = fatherLi.querySelector('.member-name');
                        if (fatherSpan && fatherSpan.textContent.trim() === fatherName) {
                            const grandUl = fatherLi.parentElement;
                            const grandLi = grandUl.closest('li'); // Grandfather Node
                            
                            if (grandLi) {
                                const grandSpan = grandLi.querySelector('.member-name');
                                if (grandSpan && grandSpan.textContent.trim() === grandName) {
                                    return { found: true, element: span, li: childLi, fatherLi: fatherLi };
                                }
                            }
                        }
                    }
                }
            }
            return { found: false };
        }

        // 3. ADD NAME LOGIC
        function addName() {
            const grand = document.getElementById('add_grand').value.trim();
            const father = document.getElementById('add_father').value.trim();
            const child = document.getElementById('add_child').value.trim();
            const html = document.getElementById('inputHtml').value;

            if(!grand || !father || !child) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç!"); return; }

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Logic: Find Father where Father's Parent is Grand
            let parentFound = false;
            const allSpans = doc.querySelectorAll('.member-name');
            
            for (let span of allSpans) {
                if (span.textContent.trim() === father) {
                    const fatherLi = span.closest('li');
                    const grandUl = fatherLi.parentElement;
                    const grandLi = grandUl.closest('li');
                    
                    if (grandLi) {
                        const grandSpan = grandLi.querySelector('.member-name');
                        if (grandSpan && grandSpan.textContent.trim() === grand) {
                            // Found verified Father -> Add Child
                            let childUl = fatherLi.querySelector('ul');
                            if (!childUl) {
                                childUl = doc.createElement('ul');
                                fatherLi.appendChild(childUl);
                            }
                            const newLi = doc.createElement('li');
                            newLi.innerHTML = `<div class="member-card"><span class="member-name">${child}</span></div>`;
                            childUl.appendChild(newLi);
                            parentFound = true; 
                            break;
                        }
                    }
                }
            }

            if(parentFound) {
                updateAndPreview(doc);
                alert("‚úÖ ‡§®‡§æ‡§Æ ‡§ú‡•Å‡§°‡§º ‡§ó‡§Ø‡§æ! ‡§®‡•Ä‡§ö‡•á 'Publish' ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§");
                document.getElementById('add_child').value = "";
            } else { alert("‚ùå ‡§™‡§ø‡§§‡§æ ‡§Ø‡§æ ‡§¶‡§æ‡§¶‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü‡•§ ‡§∏‡•ç‡§™‡•á‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"); }
        }

        // 4. EDIT NAME LOGIC (CORRECTION)
        function editName() {
            const grand = document.getElementById('edit_grand').value.trim();
            const father = document.getElementById('edit_father').value.trim();
            const oldName = document.getElementById('edit_old').value.trim();
            const newName = document.getElementById('edit_new').value.trim();
            const html = document.getElementById('inputHtml').value;

            if(!grand || !father || !oldName || !newName) { alert("‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç!"); return; }

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const result = findNode(doc, grand, father, oldName);

            if(result.found) {
                result.element.textContent = newName; // Update Text
                updateAndPreview(doc);
                alert("‚úÖ ‡§®‡§æ‡§Æ ‡§∏‡•Å‡§ß‡§∞ ‡§ó‡§Ø‡§æ! 'Publish' ‡§ï‡§∞‡•á‡§Ç‡•§");
                document.getElementById('edit_new').value = "";
            } else { alert("‚ùå ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§¶‡§æ‡§¶‡§æ/‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§∏‡§π‡•Ä ‡§π‡•à?"); }
        }

        // 5. DELETE NAME LOGIC
        function deleteName() {
            const grand = document.getElementById('del_grand').value.trim();
            const father = document.getElementById('del_father').value.trim();
            const name = document.getElementById('del_name').value.trim();
            const html = document.getElementById('inputHtml').value;

            if(!grand || !father || !name) { alert("‡§∏‡§≠‡•Ä ‡§´‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç!"); return; }
            if(!confirm("‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§Ø‡§π ‡§®‡§æ‡§Æ ‡§π‡§Æ‡•á‡§∂‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡§ü ‡§ú‡§æ‡§è‡§ó‡§æ‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")) return;

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const result = findNode(doc, grand, father, name);

            if(result.found) {
                result.li.remove(); // Remove Element
                updateAndPreview(doc);
                alert("üóëÔ∏è ‡§®‡§æ‡§Æ ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ 'Publish' ‡§ï‡§∞‡•á‡§Ç‡•§");
            } else { alert("‚ùå ‡§®‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ ‡§∏‡•ç‡§™‡•á‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"); }
        }

        // SYNC UPDATES
        function updateAndPreview(doc) {
            const updatedHTML = doc.documentElement.outerHTML;
            document.getElementById('outputHtml').value = updatedHTML;
            document.getElementById('inputHtml').value = updatedHTML;
            document.getElementById('livePreview').innerHTML = updatedHTML;
        }

        // 6. SAVE TO GITHUB
        async function saveToGitHub() {
            const token = prompt("üîë GitHub Token ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:");
            if (!token) { alert("Token ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!"); return; }

            loading(true);
            const content = document.getElementById('outputHtml').value;
            
            try {
                // Get SHA
                const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                const getRes = await fetch(apiUrl, { headers: { "Authorization": `token ${token}` } });
                const getData = await getRes.json();

                // Push Update
                const putRes = await fetch(apiUrl, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Vanshawali Updated via Royal Admin Panel",
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: getData.sha,
                        branch: BRANCH
                    })
                });

                if (putRes.ok) { alert("üéâ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à!"); } 
                else { const err = await putRes.json(); alert("Error: " + err.message); }

            } catch (err) { alert("Error: " + err.message); } 
            finally { loading(false); }
        }
    </script>

</body>
</html>