<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8">
    <title>ROYAL ARCHITECT - Final Builder</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { --dark: #121212; --panel: #1e1e24; --gold: #d4af37; --text: #e0e0e0; --accent: #007bff; }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: 'Lato', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .navbar { height: 50px; background: #000; border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 1000; }
        .brand { font-family: 'Cinzel'; color: var(--gold); font-weight: bold; font-size: 1.1em; }
        .top-btn { background: #333; color: #fff; border: 1px solid #555; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .top-btn:hover { background: #444; border-color: #fff; }
        .publish-btn { background: linear-gradient(45deg, #bf953f, #aa771c); color: #000; border: none; font-weight: bold; }

        /* WORKSPACE */
        .workspace { display: flex; height: 100%; position: relative; }

        /* SIDEBAR (TOOLS) */
        .sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; }
        .sidebar-header { padding: 10px; background: #111; border-bottom: 1px solid #333; font-weight: bold; text-align: center; color: var(--gold); font-size: 0.9em; }
        
        .tools-list { flex: 1; overflow-y: auto; padding: 10px; }
        .tool-cat { margin-bottom: 15px; }
        .cat-title { font-size: 0.7em; color: #777; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; border-bottom: 1px solid #333; }
        
        .tool-item { 
            display: flex; align-items: center; gap: 10px; padding: 8px; 
            background: #252530; border: 1px solid #333; border-radius: 4px; 
            cursor: grab; margin-bottom: 5px; transition: 0.2s; font-size: 0.85em;
        }
        .tool-item:hover { border-color: var(--gold); color: #fff; transform: translateX(2px); }
        .tool-item i { color: var(--gold); width: 15px; text-align: center; }

        /* PROPERTIES PANEL (RIGHT) */
        .props-panel { width: 280px; background: var(--panel); border-left: 1px solid #333; padding: 15px; display: none; flex-direction: column; overflow-y: auto; }
        .props-panel.active { display: flex; }
        .prop-group { margin-bottom: 15px; }
        .prop-label { display: block; font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        .prop-input { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; box-sizing: border-box; }
        .range-slider { width: 100%; cursor: pointer; }

        /* CENTER CANVAS */
        .canvas-area { flex: 1; background: #888; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .toolbar-top { height: 35px; background: #222; display: flex; justify-content: center; align-items: center; gap: 15px; border-bottom: 1px solid #444; }
        .device-icon { color: #888; cursor: pointer; font-size: 1em; padding: 5px; }
        .device-icon.active { color: #fff; }

        .frame-wrapper { flex: 1; overflow: auto; padding: 40px; display: flex; justify-content: center; align-items: flex-start; background: #555; }
        
        #editor-frame { 
            width: 100%; max-width: 100%; min-height: 800px; 
            background: #fff; border: none; box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            transition: width 0.3s; 
        }

        /* MODALS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: #222; padding: 25px; border: 2px solid var(--gold); border-radius: 8px; width: 500px; text-align: center; }
        
        /* IMAGE GRID */
        .img-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .img-thumb { aspect-ratio: 1; object-fit: cover; width: 100%; border: 1px solid #444; cursor: pointer; border-radius: 4px; }
        .img-thumb:hover { border-color: var(--gold); outline: 2px solid var(--gold); }

        /* LOADING */
        .loader { border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand"><i class="fas fa-drafting-compass"></i> ARCHITECT</div>
        <div style="display:flex; gap:10px;">
            <button onclick="undo()" class="top-btn" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
            <button onclick="redo()" class="top-btn" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
            <div style="width:1px; background:#444; margin:0 5px;"></div>
            <button onclick="openLoadModal()" class="top-btn" style="background:#0056b3;"><i class="fas fa-cloud-download-alt"></i> LOAD PAGE</button>
            <button onclick="openMediaManager()" class="top-btn"><i class="fas fa-images"></i> LIBRARY</button>
            <button onclick="openPublishModal()" class="top-btn publish-btn"><i class="fas fa-save"></i> PUBLISH</button>
        </div>
    </nav>

    <div class="workspace">
        
        <div class="sidebar">
            <div class="sidebar-header">DRAG & DROP TOOLS</div>
            <div class="tools-list">
                
                <div class="tool-cat">
                    <div class="cat-title">LAYOUTS</div>
                    <div class="tool-item" onclick="insertBlock('container')"><i class="far fa-square"></i> Blank Section</div>
                    <div class="tool-item" onclick="insertBlock('2col')"><i class="fas fa-columns"></i> 2 Columns</div>
                    <div class="tool-item" onclick="insertBlock('3col')"><i class="fas fa-th-large"></i> 3 Columns</div>
                    <div class="tool-item" onclick="insertBlock('left-img')"><i class="fas fa-id-card-alt"></i> Img Left + Text</div>
                </div>

                <div class="tool-cat">
                    <div class="cat-title">ROYAL ELEMENTS</div>
                    <div class="tool-item" onclick="insertBlock('heading')"><i class="fas fa-heading"></i> Royal Heading</div>
                    <div class="tool-item" onclick="insertBlock('text')"><i class="fas fa-paragraph"></i> Paragraph</div>
                    <div class="tool-item" onclick="insertBlock('image')"><i class="fas fa-image"></i> Image</div>
                    <div class="tool-item" onclick="insertBlock('jharokha')"><i class="fas fa-archway"></i> Jharokha Box</div>
                    <div class="tool-item" onclick="insertBlock('divider')"><i class="fas fa-grip-lines"></i> Gold Divider</div>
                    <div class="tool-item" onclick="insertBlock('button')"><i class="fas fa-mouse-pointer"></i> Button</div>
                    <div class="tool-item" onclick="insertBlock('video')"><i class="fab fa-youtube"></i> Video</div>
                </div>

            </div>
        </div>

        <div class="canvas-area">
            <div class="toolbar-top">
                <i class="fas fa-desktop device-icon active" onclick="resizeFrame('100%')"></i>
                <i class="fas fa-tablet-alt device-icon" onclick="resizeFrame('768px')"></i>
                <i class="fas fa-mobile-alt device-icon" onclick="resizeFrame('375px')"></i>
            </div>
            <div class="frame-wrapper">
                <iframe id="editor-frame"></iframe>
            </div>
        </div>

        <div class="props-panel" id="propsPanel">
            <div class="sidebar-header" style="background:none; text-align:left; border:none; padding:0 0 10px 0;">PROPERTIES</div>
            
            <div id="dynamicProps">
                <p style="color:#666; font-size:0.9em; text-align:center; margin-top:50px;">
                    Click any element on the canvas to edit.
                </p>
            </div>

            <div style="margin-top:auto; padding-top:20px; border-top:1px solid #333;">
                <button onclick="deleteSelected()" class="top-btn" style="background:#ff4444; border-color:red; width:100%; justify-content:center;">DELETE ELEMENT</button>
            </div>
        </div>

    </div>

    <div id="loadModal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold);">Edit Existing Page</h3>
            <input type="text" id="loadFile" class="prop-input" placeholder="e.g. index.html" style="margin-bottom:15px;">
            <button onclick="fetchPage()" class="top-btn" style="width:100%; justify-content:center; padding:10px;">LOAD FROM GITHUB</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="mediaModal" class="modal">
        <div class="modal-box" style="width:600px;">
            <h3 style="color:var(--gold);">Select Image</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-size:0.8em; color:#aaa;">Click image to use</span>
                <input type="file" id="uploadInput" style="display:none;" onchange="uploadImageNow()">
                <button onclick="document.getElementById('uploadInput').click()" class="top-btn" style="background:#007bff;">Upload New</button>
            </div>
            <div id="mediaGrid" class="img-grid"><div class="loader"></div></div>
            <button onclick="closeModals()" class="top-btn">Close</button>
        </div>
    </div>

    <div id="publishModal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold);">Publish Changes</h3>
            <div class="prop-group">
                <label class="prop-label">File Name (e.g. index.html)</label>
                <input type="text" id="pubFileName" class="prop-input" value="new_page.html">
            </div>
            <button onclick="startPublish()" class="top-btn publish-btn" style="width:100%; justify-content:center; padding:12px;">PUBLISH TO WEBSITE</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        const GITHUB_USER = "kasumalgarh";
        const REPO = "kasumalgarh.github.io";
        let frameDoc;
        let selectedEl = null;
        let historyStack = [];
        let historyIndex = -1;
        let pendingImageTarget = null; 

        // --- 1. INITIALIZATION ---
        window.onload = function() {
            const iframe = document.getElementById('editor-frame');
            frameDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Start with a blank royal template
            resetCanvas();
        };

        function resetCanvas(htmlContent = null) {
            const defaultHTML = `
                <!DOCTYPE html>
                <html lang="hi"><head>
                <meta charset="UTF-8">
                <title>Page</title>
                <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display&display=swap" rel="stylesheet">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                <style>
                    body { margin:0; background:#fffbf0; font-family:'Playfair Display', serif; color:#333; overflow-x:hidden; min-height:100vh; }
                    
                    /* EDITING HIGHLIGHTS */
                    .hovered-block { outline: 2px dashed #007bff !important; cursor: pointer; }
                    .active-block { outline: 2px solid #d4af37 !important; box-shadow: 0 0 15px rgba(212,175,55,0.3); position:relative; z-index:10; }
                    
                    /* COMPONENTS */
                    .container { max-width:1100px; margin:0 auto; padding:20px; }
                    .row { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px; }
                    .col { flex:1; min-width:300px; border:1px dashed rgba(0,0,0,0.1); padding:10px; }
                    
                    /* ROYAL STYLES */
                    .royal-h1 { font-family:'Cinzel'; color:#800000; border-bottom:3px solid #aa8c2c; display:inline-block; margin-bottom:15px; }
                    .royal-p { font-size:1.1em; line-height:1.6; }
                    .jharokha { border:3px double #800000; padding:20px; text-align:center; background:#fff; border-radius:15px 15px 0 0; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:20px; }
                    .divider { text-align:center; font-size:24px; color:#aa8c2c; margin:30px 0; }
                    .btn-royal { background:#000033; color:#fff; padding:10px 30px; text-decoration:none; font-family:'Cinzel'; border:1px solid #aa8c2c; display:inline-block; border-radius:50px; }
                    img { max-width:100%; height:auto; display:block; border-radius:5px; }
                </style>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"><\/script>
                </head><body id="pageBody" class="container">
                    ${htmlContent || '<div style="text-align:center; padding:50px; color:#aaa; border:2px dashed #ccc;">Start by adding Layouts or Elements from the sidebar</div>'}
                </body></html>`;
            
            frameDoc.open();
            frameDoc.write(defaultHTML);
            frameDoc.close();

            // Init Drag & Drop inside Iframe
            setTimeout(() => {
                initEditorLogic();
                saveHistory();
            }, 500);
        }

        function initEditorLogic() {
            // Click to Select
            frameDoc.body.addEventListener('click', (e) => {
                // Prevent links from navigating
                if(e.target.tagName === 'A') e.preventDefault();
                e.stopPropagation();
                
                let target = e.target;
                if(target.id === 'pageBody') return;
                
                // Climb up to find block
                while(target && target.tagName !== 'BODY' && !target.classList.contains('col') && !target.classList.contains('jharokha') && !target.tagName.match(/^H[1-6]|P|IMG|DIV$/)) {
                    target = target.parentElement;
                }
                if(target && target !== frameDoc.body) selectElement(target);
            });

            // Hover Effect
            frameDoc.body.addEventListener('mouseover', (e) => {
                e.target.classList.add('hovered-block');
            });
            frameDoc.body.addEventListener('mouseout', (e) => {
                e.target.classList.remove('hovered-block');
            });

            // Make Body Sortable (Main Container)
            new Sortable(frameDoc.getElementById('pageBody'), { animation: 150, ghostClass: 'sortable-ghost', onEnd: saveHistory });
            
            // Make Columns Sortable too
            frameDoc.querySelectorAll('.col').forEach(col => {
                new Sortable(col, { group: 'shared', animation: 150, onEnd: saveHistory });
            });
        }

        // --- 2. HISTORY SYSTEM (Undo/Redo) ---
        function saveHistory() {
            // Remove selection classes before saving
            if(selectedEl) selectedEl.classList.remove('active-block');
            
            const html = frameDoc.documentElement.outerHTML;
            
            // Restore selection class
            if(selectedEl) selectedEl.classList.add('active-block');

            if(historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            historyStack.push(html);
            historyIndex++;
        }

        function undo() {
            if(historyIndex > 0) {
                historyIndex--;
                restoreState(historyStack[historyIndex]);
            }
        }

        function redo() {
            if(historyIndex < historyStack.length - 1) {
                historyIndex++;
                restoreState(historyStack[historyIndex]);
            }
        }

        function restoreState(html) {
            frameDoc.open();
            frameDoc.write(html);
            frameDoc.close();
            setTimeout(initEditorLogic, 100);
            document.getElementById('propsPanel').classList.remove('active');
            selectedEl = null;
        }

        // --- 3. INSERT BLOCKS ---
        function insertBlock(type) {
            let html = '';
            switch(type) {
                case 'heading': html = `<h2 class="royal-h1" contenteditable="true">Edit Heading</h2>`; break;
                case 'text': html = `<p class="royal-p" contenteditable="true">Click here to edit this paragraph text. You can write anything.</p>`; break;
                case 'image': html = `<img src="https://via.placeholder.com/800x400" alt="Img">`; break;
                case 'video': html = `<div style="text-align:center;"><iframe width="100%" height="400" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0"></iframe></div>`; break;
                case 'jharokha': html = `<div class="jharokha"><h3 contenteditable="true">Title</h3><p contenteditable="true">Content goes here.</p></div>`; break;
                case 'divider': html = `<div class="divider">‚öúÔ∏è ‚öúÔ∏è ‚öúÔ∏è</div>`; break;
                case 'button': html = `<div style="text-align:center;"><a href="#" class="btn-royal" contenteditable="true">BUTTON TEXT</a></div>`; break;
                
                // Layouts
                case 'container': html = `<div style="padding:40px; border:1px dashed #ccc; margin-bottom:20px;"></div>`; break;
                case '2col': html = `<div class="row"><div class="col">Left</div><div class="col">Right</div></div>`; break;
                case '3col': html = `<div class="row"><div class="col">1</div><div class="col">2</div><div class="col">3</div></div>`; break;
                case 'left-img': html = `<div class="row"><div class="col"><img src="https://via.placeholder.com/400"></div><div class="col"><h3 contenteditable="true">Title</h3><p contenteditable="true">Text...</p></div></div>`; break;
            }

            if(html) {
                // If container/col selected, append there. Else append to body.
                if(selectedEl && (selectedEl.classList.contains('col') || selectedEl.tagName === 'DIV')) {
                    selectedEl.insertAdjacentHTML('beforeend', html);
                } else {
                    frameDoc.getElementById('pageBody').insertAdjacentHTML('beforeend', html);
                }
                
                // Re-init sortables for new elements
                initEditorLogic();
                saveHistory();
            }
        }

        // --- 4. PROPERTIES PANEL ---
        function selectElement(el) {
            if(selectedEl) selectedEl.classList.remove('active-block');
            selectedEl = el;
            selectedEl.classList.add('active-block');
            
            document.getElementById('propsPanel').classList.add('active');
            renderProps(el);
        }

        function renderProps(el) {
            const panel = document.getElementById('dynamicProps');
            let html = '';

            // Common Props
            html += generateRange('Padding', 'padding', 0, 100, parseInt(el.style.padding)||0);
            html += generateRange('Margin Bottom', 'marginBottom', 0, 100, parseInt(el.style.marginBottom)||0);
            html += generateColor('Text Color', 'color', el.style.color || '#333333');
            html += generateColor('Background', 'backgroundColor', el.style.backgroundColor || 'transparent');
            html += generateAlign(el.style.textAlign || 'left');

            // Image Props
            if(el.tagName === 'IMG') {
                html += `<div class="prop-group"><label class="prop-label">Image Source</label><button class="top-btn" onclick="openMediaManager(true)" style="width:100%;">CHANGE IMAGE</button></div>`;
                html += generateRange('Width %', 'width', 10, 100, 100, '%');
                html += generateRange('Border Radius', 'borderRadius', 0, 50, 0, 'px');
            }

            // Video Props
            if(el.querySelector('iframe')) {
                html += `<div class="prop-group"><label class="prop-label">YouTube ID</label><input type="text" class="prop-input" placeholder="Video ID" onchange="updateVideo(this.value)"></div>`;
            }

            // Link Props
            if(el.tagName === 'A') {
                html += `<div class="prop-group"><label class="prop-label">Link URL</label><input type="text" class="prop-input" value="${el.getAttribute('href')}" onchange="updateAttr('href', this.value)"></div>`;
            }

            panel.innerHTML = html;
        }

        // Helper Generators
        function generateRange(label, prop, min, max, val, unit='px') {
            return `<div class="prop-group"><label class="prop-label">${label}</label><input type="range" class="range-slider" min="${min}" max="${max}" value="${val}" oninput="updateStyle('${prop}', this.value + '${unit}')"></div>`;
        }
        function generateColor(label, prop, val) {
            return `<div class="prop-group"><label class="prop-label">${label}</label><input type="color" class="prop-input" value="${rgbToHex(val)}" oninput="updateStyle('${prop}', this.value)"></div>`;
        }
        function generateAlign(val) {
            return `<div class="prop-group"><label class="prop-label">Alignment</label><select class="prop-input" onchange="updateStyle('textAlign', this.value)"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>`;
        }

        // Updates
        function updateStyle(prop, val) { if(selectedEl) { selectedEl.style[prop] = val; saveHistory(); } }
        function updateAttr(attr, val) { if(selectedEl) { selectedEl.setAttribute(attr, val); saveHistory(); } }
        function updateVideo(id) { if(selectedEl) { selectedEl.querySelector('iframe').src = `https://www.youtube.com/embed/${id}`; saveHistory(); } }
        function deleteSelected() { 
            if(selectedEl && confirm("Delete element?")) { 
                selectedEl.remove(); 
                selectedEl = null; 
                document.getElementById('propsPanel').classList.remove('active'); 
                saveHistory(); 
            } 
        }

        // RGB to Hex helper
        function rgbToHex(col) {
            if(!col || col==='transparent') return '#ffffff';
            if(col.startsWith('#')) return col;
            var rgb = col.match(/\d+/g);
            return '#' + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
        }

        // --- 5. MEDIA LIBRARY ---
        function openMediaManager(forSelection = false) {
            pendingImageTarget = forSelection ? selectedEl : null;
            document.getElementById('mediaModal').style.display = 'flex';
            loadGithubImages();
        }

        async function loadGithubImages() {
            const grid = document.getElementById('mediaGrid');
            grid.innerHTML = '<div class="loader"></div>';
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/`);
                const data = await res.json();
                const images = data.filter(f => f.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));
                grid.innerHTML = '';
                images.forEach(img => {
                    let d = document.createElement('img');
                    d.src = img.download_url;
                    d.className = 'img-thumb';
                    d.onclick = () => selectImage(img.download_url);
                    grid.appendChild(d);
                });
            } catch(e) { grid.innerHTML = 'Error loading images'; }
        }

        function selectImage(url) {
            if(pendingImageTarget && pendingImageTarget.tagName === 'IMG') {
                pendingImageTarget.src = url;
                saveHistory();
            } else {
                // Just add new image
                const html = `<img src="${url}" class="active-block">`;
                frameDoc.getElementById('pageBody').insertAdjacentHTML('beforeend', html);
                initEditorLogic();
            }
            closeModals();
        }

        async function uploadImageNow() {
            const file = document.getElementById('newImgUpload').files[0];
            const token = prompt("Enter GitHub Token:");
            if(!file || !token) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result.split(',')[1];
                await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${file.name}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Upload", content: content, branch: "main" })
                });
                loadGithubImages();
            };
            reader.readAsDataURL(file);
        }

        // --- 6. LOAD & PUBLISH ---
        function openLoadModal() { document.getElementById('loadModal').style.display = 'flex'; }
        function openPublishModal() { document.getElementById('publishModal').style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function resizeFrame(w) { document.getElementById('editor-frame').style.width = w; document.querySelectorAll('.device-icon').forEach(d=>d.classList.remove('active')); event.target.classList.add('active'); }

        async function fetchPage() {
            const file = document.getElementById('loadFile').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${file}`);
                if(!res.ok) throw new Error("File not found");
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                
                frameDoc.open();
                frameDoc.write(content);
                frameDoc.close();
                
                // Inject Editor Scripts again
                setTimeout(() => {
                    let script = frameDoc.createElement('script');
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js";
                    frameDoc.head.appendChild(script);
                    setTimeout(() => { initEditorLogic(); saveHistory(); }, 500);
                }, 500);
                
                closeModals();
                document.getElementById('pubFileName').value = file; // Auto set save name
            } catch(e) { alert("Error: " + e.message); }
        }

        async function startPublish() {
            const fileName = document.getElementById('pubFileName').value;
            const token = prompt("üîë Paste GitHub Token:");
            if(!token) return;

            // Cleanup before saving
            if(selectedEl) selectedEl.classList.remove('active-block');
            // Remove sortable classes
            let html = frameDoc.documentElement.outerHTML;
            
            // Basic cleanup of editor classes (optional but good)
            html = html.replace(/hovered-block|active-block/g, '');

            try {
                // Check SHA
                let sha = null;
                try {
                    let r = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${fileName}`);
                    if(r.ok) { let d = await r.json(); sha = d.sha; }
                } catch(e){}

                await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${fileName}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Updated via Royal Architect",
                        content: btoa(unescape(encodeURIComponent(html))),
                        sha: sha,
                        branch: "main"
                    })
                });
                alert("üéâ SUCCESS! Page Published.");
                closeModals();
            } catch(e) { alert("Error: " + e.message); }
        }

    </script>
</body>
</html>
