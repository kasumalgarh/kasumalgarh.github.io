<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8">
    <title>KASUMALGARH ARCHITECT - Ultimate Builder</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root { --dark: #121212; --panel: #1e1e24; --gold: #d4af37; --text: #e0e0e0; --accent: #007bff; }
        body { margin: 0; background: var(--dark); color: var(--text); font-family: 'Lato', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .navbar { height: 50px; background: #000; border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; z-index: 1000; }
        .brand { font-family: 'Cinzel'; color: var(--gold); font-weight: bold; font-size: 1.1em; display:flex; align-items:center; gap:10px; }
        .top-btn { background: #333; color: #fff; border: 1px solid #555; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .top-btn:hover { background: #444; border-color: #fff; }
        .publish-btn { background: linear-gradient(45deg, #bf953f, #aa771c); color: #000; border: none; font-weight: bold; }

        /* WORKSPACE */
        .workspace { display: flex; height: 100%; position: relative; }

        /* SIDEBAR (TOOLS) */
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 10px; background: #111; border-bottom: 1px solid #333; font-weight: bold; text-align: center; color: var(--gold); }
        
        .tools-list { flex: 1; overflow-y: auto; padding: 10px; }
        .tool-cat { margin-bottom: 15px; }
        .cat-title { font-size: 0.75em; color: #777; font-weight: bold; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        
        .tool-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px; 
            background: #252530; border: 1px solid #333; border-radius: 5px; 
            cursor: pointer; margin-bottom: 5px; transition: 0.2s; font-size: 0.9em;
        }
        .tool-item:hover { background: #303040; border-color: var(--gold); color: #fff; transform: translateX(5px); }
        .tool-item i { color: var(--gold); width: 20px; text-align: center; }

        /* PROPERTIES PANEL (RIGHT - HIDDEN BY DEFAULT) */
        .props-panel { width: 280px; background: var(--panel); border-left: 1px solid #333; padding: 15px; display: none; flex-direction: column; overflow-y: auto; }
        .props-panel.active { display: flex; }
        .prop-group { margin-bottom: 15px; }
        .prop-label { display: block; font-size: 0.8em; color: #aaa; margin-bottom: 5px; }
        .prop-input { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 6px; border-radius: 4px; }
        .range-slider { width: 100%; cursor: pointer; }

        /* CENTER CANVAS */
        .canvas-area { flex: 1; background: #888; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .toolbar-top { height: 40px; background: #222; display: flex; justify-content: center; align-items: center; gap: 15px; border-bottom: 1px solid #444; }
        .device-icon { color: #888; cursor: pointer; font-size: 1.1em; padding: 5px; }
        .device-icon.active { color: #fff; }

        .frame-wrapper { flex: 1; overflow: auto; padding: 40px; display: flex; justify-content: center; align-items: flex-start; }
        
        /* THE EDITABLE IFRAME WRAPPER */
        #editor-frame { 
            width: 100%; max-width: 100%; min-height: 100%; 
            background: #fff; border: none; box-shadow: 0 0 50px rgba(0,0,0,0.5); 
            transition: width 0.3s; 
        }

        /* MODALS */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: #222; padding: 25px; border: 2px solid var(--gold); border-radius: 8px; width: 450px; text-align: center; }
        
        /* IMAGE GRID IN MODAL */
        .img-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .img-thumb { aspect-ratio: 1; object-fit: cover; width: 100%; border: 1px solid #444; cursor: pointer; }
        .img-thumb:hover { border-color: var(--gold); outline: 2px solid var(--gold); }

        /* LOADING */
        .loader { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand"><i class="fas fa-drafting-compass"></i> ARCHITECT</div>
        <div style="display:flex; gap:10px;">
            <button onclick="undo()" class="top-btn"><i class="fas fa-undo"></i> Undo</button>
            <button onclick="redo()" class="top-btn"><i class="fas fa-redo"></i> Redo</button>
            <div style="width:1px; background:#444; margin:0 5px;"></div>
            <button onclick="loadPageDialog()" class="top-btn" style="background:#0056b3;"><i class="fas fa-cloud-download-alt"></i> LOAD PAGE</button>
            <button onclick="openMediaManager()" class="top-btn"><i class="fas fa-images"></i> MEDIA</button>
            <button onclick="publishDialog()" class="top-btn publish-btn"><i class="fas fa-save"></i> SAVE & PUBLISH</button>
        </div>
    </nav>

    <div class="workspace">
        
        <div class="sidebar">
            <div class="sidebar-header">BUILDER TOOLS</div>
            <div class="tools-list">
                
                <div class="tool-cat">
                    <div class="cat-title">LAYOUTS</div>
                    <div class="tool-item" onclick="insertBlock('container')"><i class="fas fa-square"></i> Empty Section</div>
                    <div class="tool-item" onclick="insertBlock('2col')"><i class="fas fa-columns"></i> 2 Columns (50/50)</div>
                    <div class="tool-item" onclick="insertBlock('3col')"><i class="fas fa-columns"></i> 3 Columns (Grid)</div>
                    <div class="tool-item" onclick="insertBlock('left-img')"><i class="fas fa-id-card-alt"></i> Image Left + Text</div>
                </div>

                <div class="tool-cat">
                    <div class="cat-title">ELEMENTS</div>
                    <div class="tool-item" onclick="insertBlock('heading')"><i class="fas fa-heading"></i> Royal Heading</div>
                    <div class="tool-item" onclick="insertBlock('text')"><i class="fas fa-paragraph"></i> Text Block</div>
                    <div class="tool-item" onclick="insertBlock('image')"><i class="fas fa-image"></i> Image</div>
                    <div class="tool-item" onclick="insertBlock('video')"><i class="fab fa-youtube"></i> YouTube Video</div>
                    <div class="tool-item" onclick="insertBlock('button')"><i class="fas fa-mouse-pointer"></i> Button</div>
                    <div class="tool-item" onclick="insertBlock('divider')"><i class="fas fa-grip-lines"></i> Gold Divider</div>
                </div>

                <div class="tool-cat">
                    <div class="cat-title">SPECIAL</div>
                    <div class="tool-item" onclick="insertBlock('jharokha')"><i class="fas fa-archway"></i> Jharokha Box</div>
                    <div class="tool-item" onclick="insertBlock('profile')"><i class="fas fa-user-tie"></i> Profile Card</div>
                </div>

            </div>
        </div>

        <div class="canvas-area">
            <div class="toolbar-top">
                <i class="fas fa-desktop device-icon active" onclick="resizeFrame('100%')"></i>
                <i class="fas fa-tablet-alt device-icon" onclick="resizeFrame('768px')"></i>
                <i class="fas fa-mobile-alt device-icon" onclick="resizeFrame('375px')"></i>
            </div>
            <div class="frame-wrapper">
                <iframe id="editor-frame"></iframe>
            </div>
        </div>

        <div class="props-panel" id="propsPanel">
            <div class="sidebar-header" style="background:none; text-align:left; border:none; padding:0 0 10px 0;">EDIT PROPERTIES</div>
            
            <div id="dynamicProps">
                <p style="color:#666; font-size:0.9em;">Select an element to edit styles, size, or content.</p>
            </div>

            <button onclick="deleteSelected()" class="top-btn" style="background:red; border-color:red; margin-top:20px; width:100%; justify-content:center;">DELETE ELEMENT</button>
        </div>

    </div>

    <div id="loadModal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold);">Load Existing Page</h3>
            <input type="text" id="loadFile" class="prop-input" placeholder="e.g. index.html" style="margin-bottom:10px;">
            <button onclick="fetchPage()" class="top-btn" style="width:100%; justify-content:center;">FETCH FROM GITHUB</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="mediaModal" class="modal">
        <div class="modal-box" style="width:600px;">
            <h3 style="color:var(--gold);">Media Library</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="file" id="newImgUpload" style="display:none;" onchange="uploadImageNow()">
                <button onclick="document.getElementById('newImgUpload').click()" class="top-btn" style="background:#007bff;"><i class="fas fa-upload"></i> Upload New</button>
            </div>
            <div id="mediaGrid" class="img-grid">Loading...</div>
            <button onclick="closeModals()" class="top-btn">Close</button>
        </div>
    </div>

    <div id="publishModal" class="modal">
        <div class="modal-box">
            <h3 style="color:var(--gold);">Publish Page</h3>
            <div class="prop-group">
                <label class="prop-label">File Name (must end with .html)</label>
                <input type="text" id="pubFileName" class="prop-input" value="new_page.html">
            </div>
            <button onclick="startPublish()" class="top-btn publish-btn" style="width:100%; justify-content:center;">PUBLISH NOW</button>
            <button onclick="closeModals()" style="background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE ---
        const GITHUB_USER = "kasumalgarh";
        const REPO = "kasumalgarh.github.io";
        let frameDoc;
        let selectedEl = null;
        let historyStack = [];
        let historyIndex = -1;
        let pendingImageTarget = null; // To know where to put selected image

        // --- INIT ---
        window.onload = function() {
            const iframe = document.getElementById('editor-frame');
            frameDoc = iframe.contentDocument || iframe.contentWindow.document;
            
            // Initialize Empty Template
            resetCanvas();
        };

        function resetCanvas(htmlContent = null) {
            const defaultHTML = `
                <!DOCTYPE html>
                <html><head>
                <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display&display=swap" rel="stylesheet">
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                <style>
                    body { margin:0; background:#fffbf0; font-family:'Playfair Display', serif; color:#333; padding:20px; overflow-x:hidden; }
                    
                    /* EDITOR HELPERS (Outline on hover) */
                    *[data-editable]:hover { outline: 2px dashed #007bff; cursor: pointer; }
                    *[data-editable].active { outline: 2px solid #d4af37; box-shadow: 0 0 10px rgba(212,175,55,0.5); }
                    
                    /* UTILS */
                    .row { display:flex; flex-wrap:wrap; gap:20px; margin-bottom:20px; }
                    .col { flex:1; min-width:300px; }
                    img { max-width:100%; height:auto; display:block; }
                    
                    /* ROYAL STYLES */
                    .royal-h1 { font-family:'Cinzel'; color:#800000; border-bottom:3px solid #aa8c2c; display:inline-block; }
                    .jharokha { border:3px double #800000; padding:20px; text-align:center; background:#fff; border-radius:10px; }
                    .btn-royal { background:#000033; color:#fff; padding:10px 25px; text-decoration:none; font-family:'Cinzel'; border:1px solid #aa8c2c; display:inline-block; }
                </style>
                </head><body id="pageBody">
                    ${htmlContent || '<div class="row" data-editable="container" style="min-height:200px; border:1px dashed #ccc; justify-content:center; align-items:center;"><p style="color:#aaa;">Drag & Drop elements here or use Sidebar</p></div>'}
                </body></html>`;
            
            frameDoc.open();
            frameDoc.write(defaultHTML);
            frameDoc.close();

            // Inject Script for Click Handling inside Iframe
            setTimeout(() => {
                frameDoc.body.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    let target = e.target.closest('[data-editable]');
                    if(target) selectElement(target);
                });
                
                // Enable Sortable (Drag & Drop)
                new Sortable(frameDoc.body, { animation: 150, ghostClass: 'sortable-ghost' });
                saveHistory();
            }, 500);
        }

        // --- HISTORY (UNDO/REDO) ---
        function saveHistory() {
            if(historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            historyStack.push(frameDoc.body.innerHTML);
            historyIndex++;
        }

        function undo() {
            if(historyIndex > 0) {
                historyIndex--;
                frameDoc.body.innerHTML = historyStack[historyIndex];
                reattachListeners();
            }
        }

        function redo() {
            if(historyIndex < historyStack.length - 1) {
                historyIndex++;
                frameDoc.body.innerHTML = historyStack[historyIndex];
                reattachListeners();
            }
        }

        function reattachListeners() {
            // Re-bind click events after innerHTML swap
            // (Sortable needs re-init usually, kept simple here)
        }

        // --- INSERT BLOCKS ---
        function insertBlock(type) {
            let html = '';
            let id = 'el-' + Date.now();
            
            switch(type) {
                case 'heading': html = `<h2 data-editable="text" style="text-align:center;" class="royal-h1">New Heading</h2>`; break;
                case 'text': html = `<p data-editable="text" style="font-size:1.1em; line-height:1.6;">Start writing your content here...</p>`; break;
                case 'image': html = `<img data-editable="image" src="https://via.placeholder.com/800x400" alt="Image">`; break;
                case 'video': html = `<div data-editable="video" style="text-align:center;"><iframe width="100%" height="400" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0"></iframe></div>`; break;
                case 'button': html = `<div style="text-align:center;" data-editable="container"><a href="#" class="btn-royal" data-editable="link">Click Me</a></div>`; break;
                case 'divider': html = `<div data-editable="style" style="text-align:center; font-size:24px; color:#aa8c2c; margin:20px 0;">‚öúÔ∏è ‚öúÔ∏è ‚öúÔ∏è</div>`; break;
                
                // Layouts
                case '2col': html = `<div class="row" data-editable="container"><div class="col" style="padding:10px; border:1px dashed #ccc;">Left Content</div><div class="col" style="padding:10px; border:1px dashed #ccc;">Right Content</div></div>`; break;
                case '3col': html = `<div class="row" data-editable="container"><div class="col" style="border:1px dashed #ccc;">1</div><div class="col" style="border:1px dashed #ccc;">2</div><div class="col" style="border:1px dashed #ccc;">3</div></div>`; break;
                case 'jharokha': html = `<div class="jharokha" data-editable="container"><h3>Title</h3><p>Content goes here.</p></div>`; break;
            }

            if(html) {
                if(selectedEl && selectedEl.classList.contains('col')) {
                    selectedEl.insertAdjacentHTML('beforeend', html); // Add inside selected column
                } else {
                    frameDoc.body.insertAdjacentHTML('beforeend', html); // Add at bottom
                }
                saveHistory();
            }
        }

        // --- SELECTION & PROPERTIES ---
        function selectElement(el) {
            // Remove active class from old
            if(selectedEl) selectedEl.classList.remove('active');
            selectedEl = el;
            selectedEl.classList.add('active');
            
            document.getElementById('propsPanel').classList.add('active');
            renderProperties(el);
        }

        function renderProperties(el) {
            const panel = document.getElementById('dynamicProps');
            const type = el.getAttribute('data-editable');
            let html = '';

            // Common: Margin/Padding
            html += `<div class="prop-group"><label class="prop-label">Margin Top/Bottom</label><input type="range" class="range-slider" min="0" max="100" oninput="updateStyle('margin', this.value + 'px 0')"></div>`;

            if(type === 'text' || el.tagName.match(/^H[1-6]|P$/)) {
                html += `<div class="prop-group"><label class="prop-label">Text Content</label><textarea class="prop-input" rows="4" oninput="updateContent(this.value)">${el.innerText}</textarea></div>`;
                html += `<div class="prop-group"><label class="prop-label">Alignment</label><select class="prop-input" onchange="updateStyle('textAlign', this.value)"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select></div>`;
                html += `<div class="prop-group"><label class="prop-label">Color</label><input type="color" class="prop-input" onchange="updateStyle('color', this.value)"></div>`;
            }
            
            if(type === 'image') {
                html += `<div class="prop-group"><label class="prop-label">Image Source</label><button class="top-btn" onclick="openMediaManager('src')" style="width:100%;">CHANGE IMAGE</button></div>`;
                html += `<div class="prop-group"><label class="prop-label">Width (%)</label><input type="range" class="range-slider" min="10" max="100" value="100" oninput="updateStyle('width', this.value + '%')"></div>`;
            }

            if(type === 'video') {
                html += `<div class="prop-group"><label class="prop-label">YouTube Video ID</label><input type="text" class="prop-input" placeholder="dQw4w9WgXcQ" onchange="updateVideo(this.value)"></div>`;
            }

            panel.innerHTML = html;
        }

        // Live Updates
        function updateContent(val) { if(selectedEl) selectedEl.innerText = val; }
        function updateStyle(prop, val) { if(selectedEl) selectedEl.style[prop] = val; }
        function updateVideo(id) { 
            if(selectedEl) selectedEl.querySelector('iframe').src = `https://www.youtube.com/embed/${id}`; 
        }
        function deleteSelected() {
            if(selectedEl) {
                if(confirm('Delete selected element?')) {
                    selectedEl.remove();
                    selectedEl = null;
                    document.getElementById('propsPanel').classList.remove('active');
                    saveHistory();
                }
            }
        }

        // --- MEDIA MANAGER ---
        function openMediaManager(targetProp = null) {
            if(targetProp === 'src') pendingImageTarget = selectedEl;
            else pendingImageTarget = null; // Just opening library
            
            document.getElementById('mediaModal').style.display = 'flex';
            loadGithubImages();
        }

        async function loadGithubImages() {
            const grid = document.getElementById('mediaGrid');
            grid.innerHTML = '<div class="loader"></div>';
            
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/`);
                const data = await res.json();
                const images = data.filter(f => f.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));
                
                grid.innerHTML = '';
                images.forEach(img => {
                    let d = document.createElement('div');
                    d.innerHTML = `<img src="${img.download_url}" class="img-thumb" onclick="selectImage('${img.download_url}')">`;
                    grid.appendChild(d);
                });
            } catch(e) { grid.innerHTML = 'Error loading images'; }
        }

        function selectImage(url) {
            if(pendingImageTarget) {
                pendingImageTarget.src = url;
            } else {
                insertBlock('image'); // Just add new if nothing selected
                // (Wait for DOM update then set src - simplified here)
            }
            closeModals();
            saveHistory();
        }

        async function uploadImageNow() {
            const file = document.getElementById('newImgUpload').files[0];
            const token = prompt("Enter GitHub Token to Upload:");
            if(!file || !token) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const content = e.target.result.split(',')[1];
                try {
                    await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${file.name}`, {
                        method: "PUT",
                        headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "Upload via Builder", content: content, branch: "main" })
                    });
                    alert("Uploaded!");
                    loadGithubImages(); // Refresh
                } catch(e) { alert("Upload Failed"); }
            };
            reader.readAsDataURL(file);
        }

        // --- LOAD PAGE ---
        function loadPageDialog() { document.getElementById('loadModal').style.display = 'flex'; }
        
        async function fetchPage() {
            const file = document.getElementById('loadFile').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${file}`);
                const data = await res.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                
                frameDoc.open();
                frameDoc.write(content);
                frameDoc.close();
                
                // Re-inject edit styles/scripts
                setTimeout(() => {
                    let style = frameDoc.createElement('style');
                    style.innerHTML = `*[data-editable]:hover { outline: 2px dashed blue; cursor: pointer; }`;
                    frameDoc.head.appendChild(style);
                    // Add listeners...
                    saveHistory();
                }, 1000);
                
                closeModals();
            } catch(e) { alert("File not found or error loading."); }
        }

        // --- PUBLISH ---
        function publishDialog() { document.getElementById('publishModal').style.display = 'flex'; }
        
        async function startPublish() {
            const fileName = document.getElementById('pubFileName').value;
            const token = prompt("GitHub Token:");
            if(!token) return;

            // Clean up: Remove edit classes/styles before saving
            let cleanDoc = frameDoc.documentElement.cloneNode(true);
            let content = cleanDoc.outerHTML;

            // (Ideally, we strip the 'active' class and edit listeners logic here)

            try {
                // Check SHA
                let sha = null;
                try {
                    let r = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${fileName}`);
                    if(r.ok) { let d = await r.json(); sha = d.sha; }
                } catch(e){}

                await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO}/contents/${fileName}`, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Published via Architect",
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: sha,
                        branch: "main"
                    })
                });
                alert("üéâ Published Successfully!");
                closeModals();
            } catch(e) { alert("Error publishing: " + e.message); }
        }

        // UTILS
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function resizeFrame(w) { document.getElementById('editor-frame').style.width = w; }

    </script>
</body>
</html>
