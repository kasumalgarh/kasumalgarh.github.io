<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="utf-8">
    <title>KASUMALGARH :: Admin Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* A. ROYAL THEME BASE */
        body {
            background-color: #2c0001; /* ‡§ó‡§π‡§∞‡§æ ‡§∂‡§æ‡§π‡•Ä ‡§≤‡§æ‡§≤ */
            color: #f4f4f4;
            font-family: 'Playfair Display', serif;
            text-align: center;
            padding: 0; margin: 0;
        }

        /* ‡§Ø‡§π ‡§ï‡•ç‡§≤‡§æ‡§∏ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§∏‡§π‡•Ä ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§ï‡§Ç‡§ü‡•á‡§Ç‡§ü ‡§¶‡§ø‡§ñ‡§æ‡§è‡§ó‡•Ä */
        #dashboard-content { display: none; }

        h2, h3, h4 { color: #d4af37; font-family: 'Cinzel', serif; text-transform: uppercase; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* NAVBAR */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: #1a0000; border-bottom: 2px solid #d4af37; }
        .logout-btn { color: #ff4444 !important; font-weight: bold; border: 1px solid #ff4444; padding: 5px 15px; border-radius: 20px; text-decoration: none; }
        
        /* EDITOR SECTION */
        .editor-section { border-top: 4px double #d4af37; margin-top: 40px; padding-top: 30px; background: rgba(0, 0, 0, 0.3); }
        .editor-wrapper { display: flex; gap: 20px; flex-wrap: wrap; text-align: left; }
        
        .editor-panel { flex: 1; min-width: 350px; background-color: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 10px; border: 2px solid #d4af37; }
        .preview-panel { flex: 1; min-width: 350px; background-color: #fdf5e6; color: #333; padding: 20px; border-radius: 10px; border: 2px solid #d4af37; max-height: 800px; overflow-y: auto; }

        /* INPUTS & BUTTONS */
        input[type="text"], textarea { width: 100%; padding: 10px; margin-bottom: 15px; background-color: #222; color: #fff; border: 1px solid #d4af37; border-radius: 5px; box-sizing: border-box; }
        textarea { min-height: 120px; font-family: monospace; font-size: 0.9em; }
        
        .tool-btn { background-color: #b38728; color: #000; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; transition: 0.3s; }
        .tool-btn:hover { background-color: #ffd700; }
        
        .delete-btn { background-color: #ff4444; color: white; border: 1px solid white; }
        .delete-btn:hover { background-color: #cc0000; }

        .save-btn { background-color: #ff0000; color: white; margin-top: 10px; font-size: 1.2em; border: 2px solid white; }
        
        /* PREVIEW TREE STYLE */
        .tree ul { list-style: none; padding-left: 20px; margin: 0; border-left: 2px solid #800000; }
        .tree li { padding: 5px 0; position: relative; }
        .member-card { border: 2px solid #b38728; padding: 5px 10px; background: #fffbf0; color: #800000; font-weight: bold; display: inline-block; border-radius: 5px; }
    </style>
</head>

<body>

    <nav class="navbar">
        <div style="font-family:'Cinzel'; font-size:1.5em; font-weight:bold; color:#fcf6ba;">KASUMALGARH ADMIN</div>
        <a href="index.html" class="logout-btn">Logout</a>
    </nav>

    <div id="dashboard-content" class="container">
        
        <div class="editor-section">
            <h2 style="color:#d4af37;">üìù Vanshavali Manager</h2>
            <p style="color:#ccc;">‡§®‡§æ‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç ‡§Ø‡§æ ‡§π‡§ü‡§æ‡§è‡§Ç, ‡§´‡§ø‡§∞ 'Save' ‡§ï‡§∞‡•á‡§Ç‡•§</p>

            <div class="editor-wrapper">
                
                <div class="editor-panel">
                    
                    <h3>1. ‡§ï‡•ã‡§° ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</h3>
                    <button onclick="fetchLiveCode()" class="tool-btn" style="background:#008080; color:#fff;">üåê Load Live Code (Auto)</button>
                    <textarea id="inputHtml" style="display:none;"></textarea>

                    <hr style="border-color:#555; margin: 20px 0;">

                    <h3>2. ‡§®‡§æ‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (Add)</h3>
                    <input type="text" id="parentName" placeholder="‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ (Father): Ex: Th. Bhairu Singh">
                    <input type="text" id="newName" placeholder="‡§®‡§Ø‡§æ ‡§®‡§æ‡§Æ (Child): Ex: Kr. Yuvraj Singh">
                    <button onclick="addName()" class="tool-btn">‚ûï ‡§®‡§æ‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</button>

                    <hr style="border-color:#555; margin: 20px 0;">

                    <h3 style="color:#ff4444;">3. ‡§®‡§æ‡§Æ ‡§π‡§ü‡§æ‡§è‡§Å (Delete)</h3>
                    <p style="font-size:0.8em; color:#ccc;">‡§ó‡§≤‡§§‡•Ä ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è, ‡§π‡§ü‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡•á ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§â‡§∏‡§ï‡•á ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§</p>
                    
                    <input type="text" id="deleteNameInput" placeholder="‡§π‡§ü‡§æ‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§®‡§æ‡§Æ (Name to Delete)">
                    <input type="text" id="parentOfDeleteInput" placeholder="‡§â‡§∏‡§ï‡•á ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ (His Father's Name)">
                    
                    <button onclick="deleteName()" class="tool-btn delete-btn">üóëÔ∏è ‡§®‡§æ‡§Æ ‡§π‡§ü‡§æ‡§è‡§Ç (DELETE)</button>

                    <hr style="border-color:#555; margin: 20px 0;">

                    <h3>4. ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</h3>
                    <textarea id="outputHtml" readonly placeholder="‡§®‡§Ø‡§æ ‡§ï‡•ã‡§° ‡§Ø‡§π‡§æ‡§Å ‡§¨‡§®‡•á‡§ó‡§æ..." style="height:60px; color:#aaa;"></textarea>
                    <button onclick="saveToGitHub()" class="tool-btn save-btn">üíæ SAVE TO WEBSITE (LIVE)</button>
                </div>

                <div class="preview-panel">
                    <h3 style="color:#800000; border-bottom:1px solid #800000;">Live Preview</h3>
                    <div id="livePreview" class="tree">
                        <p style="color:#666; font-style:italic; padding:20px;">'Load Live Code' ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ‚ö†Ô∏è CONFIGURATION (‡§Ø‡§π‡§æ‡§Å ‡§Ö‡§™‡§®‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç)
        // ============================================
        const GITHUB_USERNAME = "kasumalgarh";       
        const REPO_NAME = "kasumalgarh.github.io";   
        const FILE_PATH = "vanshawali.html";         
        const BRANCH = "main";                       
        const ADMIN_PASSWORD = "kasumalgarh2025";    
        // ============================================

        // 1. PASSWORD CHECK ON LOAD
        window.onload = function() {
            let attempt = prompt("Admin Password ‡§°‡§æ‡§≤‡§ø‡§Ø‡•á:");
            if (attempt === ADMIN_PASSWORD) {
                document.getElementById('dashboard-content').style.display = "block";
            } else {
                alert("‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!");
                window.location.href = "index.html";
            }
        };

        // 2. FETCH LIVE CODE
        async function fetchLiveCode() {
            const btn = document.querySelector('button[onclick="fetchLiveCode()"]');
            btn.innerHTML = "‚è≥ Loading...";
            try {
                // cache ‡§∏‡•á ‡§¨‡§ö‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è timestamp ‡§≤‡§ó‡§æ‡§Ø‡§æ
                const response = await fetch(FILE_PATH + '?v=' + new Date().getTime());
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                document.getElementById('inputHtml').value = text;
                document.getElementById('outputHtml').value = text;
                loadPreview();
                alert("‚úÖ ‡§ï‡•ã‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
            } catch (err) { alert("Error: " + err.message); } 
            finally { btn.innerHTML = "üåê Load Live Code (Auto)"; }
        }

        // 3. LOAD PREVIEW
        function loadPreview() {
            const code = document.getElementById('inputHtml').value;
            if(code) document.getElementById('livePreview').innerHTML = code;
        }

        // 4. ADD NAME LOGIC
        function addName() {
            const htmlContent = document.getElementById('inputHtml').value;
            const parent = document.getElementById('parentName').value.trim();
            const child = document.getElementById('newName').value.trim();

            if (!htmlContent || !parent || !child) { alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç!"); return; }

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const allSpans = doc.querySelectorAll('.member-name');
            let parentFound = false;

            for (let span of allSpans) {
                if (span.textContent.trim() === parent) {
                    const parentLi = span.closest('li'); 
                    let childUl = parentLi.querySelector('ul');
                    if (!childUl) {
                        childUl = doc.createElement('ul');
                        parentLi.appendChild(childUl);
                    }
                    const newLi = doc.createElement('li');
                    newLi.innerHTML = `<div class="member-card"><span class="member-name">${child}</span></div>`;
                    childUl.appendChild(newLi);
                    parentFound = true;
                    break; 
                }
            }

            if (parentFound) {
                updateAndPreview(doc);
                alert("‚úÖ ‡§®‡§æ‡§Æ ‡§ú‡•Å‡§°‡§º ‡§ó‡§Ø‡§æ! ‡§Ö‡§¨ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç‡•§");
            } else { alert("‚ùå ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ (Father Name) ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§"); }
        }

        // 5. DELETE NAME LOGIC (With Parent Check)
        function deleteName() {
            const nameToDelete = document.getElementById('deleteNameInput').value.trim();
            const parentOfDelete = document.getElementById('parentOfDeleteInput').value.trim();
            const htmlContent = document.getElementById('inputHtml').value;

            if (!nameToDelete || !parentOfDelete || !htmlContent) { alert("‡§¶‡•ã‡§®‡•ã‡§Ç ‡§®‡§æ‡§Æ ‡§≠‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ï‡•ã‡§° ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç!"); return; }

            if(!confirm(`‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä: ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ${parentOfDelete} ‡§ï‡•á ‡§¨‡•á‡§ü‡•á "${nameToDelete}" ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) return;

            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const allSpans = doc.querySelectorAll('.member-name');
            let deleted = false;

            for (let span of allSpans) {
                // 1. ‡§®‡§æ‡§Æ ‡§Æ‡•à‡§ö ‡§ï‡§∞‡•ã
                if (span.textContent.trim() === nameToDelete) {
                    const liToDelete = span.closest('li'); 
                    const parentUl = liToDelete ? liToDelete.parentElement : null;

                    if (parentUl) {
                        // 2. ‡§â‡§∏‡§ï‡§æ ‡§™‡§ø‡§§‡§æ (Parent) ‡§¢‡•Ç‡§Å‡§¢‡•ã
                        const grandParentLi = parentUl.closest('li');
                        // ‡§Ö‡§ó‡§∞ top level (founder) ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à
                        if(grandParentLi) {
                            const grandParentSpan = grandParentLi.querySelector('.member-name');
                            
                            // 3. ‡§ö‡•á‡§ï ‡§ï‡§∞‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§Æ‡•à‡§ö ‡§ï‡§∞‡§§‡§æ ‡§π‡•à?
                            if (grandParentSpan && grandParentSpan.textContent.trim() === parentOfDelete) {
                                liToDelete.remove(); // DELETE
                                deleted = true;
                                break; 
                            }
                        }
                    }
                }
            }

            if (deleted) {
                updateAndPreview(doc);
                alert(`üóëÔ∏è "${nameToDelete}" ‡§ï‡•ã ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§π‡§ü‡§æ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§Ö‡§¨ 'Save' ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§`);
                document.getElementById('deleteNameInput').value = ""; 
                document.getElementById('parentOfDeleteInput').value = ""; 
            } else {
                alert(`‚ùå ‡§®‡§æ‡§Æ ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§π‡•Å‡§Ü! \n‡§Ø‡§æ ‡§§‡•ã "${nameToDelete}" ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, \n‡§Ø‡§æ ‡§â‡§∏‡§ï‡•á ‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ "${parentOfDelete}" ‡§ó‡§≤‡§§ ‡§π‡•à‡•§`);
            }
        }

        // Helper to sync changes
        function updateAndPreview(doc) {
            const updatedHTML = doc.documentElement.outerHTML;
            document.getElementById('outputHtml').value = updatedHTML;
            document.getElementById('livePreview').innerHTML = updatedHTML;
            document.getElementById('inputHtml').value = updatedHTML; 
        }

        // 6. SAVE TO GITHUB
        async function saveToGitHub() {
            const token = prompt("GitHub Secret Token ‡§™‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç:");
            if (!token) { alert("Token ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à!"); return; }

            const content = document.getElementById('outputHtml').value;
            if (!content) { alert("‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à!"); return; }

            const btn = document.querySelector('.save-btn');
            btn.innerHTML = "‚è≥ Saving...";

            try {
                // Step A: Get SHA
                const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`;
                const getRes = await fetch(apiUrl, { headers: { "Authorization": `token ${token}` } });
                
                if(!getRes.ok) throw new Error("GitHub ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§Ø‡§æ‡•§ Token ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§");
                
                const getData = await getRes.json();

                // Step B: Push Update
                const putRes = await fetch(apiUrl, {
                    method: "PUT",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: "Vanshawali Updated via Admin Panel",
                        content: btoa(unescape(encodeURIComponent(content))),
                        sha: getData.sha,
                        branch: BRANCH
                    })
                });

                if (putRes.ok) {
                    alert("üéâ ‡§µ‡•á‡§¨‡§∏‡§æ‡§á‡§ü ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§à ‡§π‡•à! (1-2 ‡§Æ‡§ø‡§®‡§ü ‡§á‡§Ç‡§§‡§ú‡§º‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç)");
                } else { 
                    const err = await putRes.json(); 
                    alert("Error: " + err.message); 
                }

            } catch (err) { alert("Network Error: " + err.message); } 
            finally { btn.innerHTML = "üíæ SAVE TO WEBSITE (LIVE)"; }
        }
    </script>

</body>
</html>
